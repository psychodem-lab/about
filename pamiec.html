<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PamiÄ™tnik Binarny Pro</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'%3E%3Cpath d='M12 2C9.243 2 7 4.243 7 7v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V7c0-2.757-2.243-5-5-5zm-3 5c0-1.654 1.346-3 3-3s3 1.346 3 3v3H9V7z'/%3E%3C/svg%3E" type="image/svg+xml">

    <style>
        :root { 
            --p: #6366f1; 
            --p-light: rgba(99, 102, 241, 0.15);
            --bg: #f8fafc; 
            --card-bg: #ffffff;
            --txt: #1e293b; 
            --txt-muted: #64748b;
            --border: #e2e8f0;
            --input-bg: #ffffff;
        }

        @media (prefers-color-scheme: dark) {
            :root { 
                --bg: #0f172a; 
                --card-bg: #1e293b;
                --txt: #f8fafc; 
                --txt-muted: #94a3b8;
                --border: #334155;
                --input-bg: #0f172a;
                --p-light: rgba(99, 102, 241, 0.25);
            }
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); color: var(--txt); 
            padding: 15px; display: flex; justify-content: center; margin: 0;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .app { width: 100%; max-width: 600px; transition: all 0.3s ease; }
        
        .card { 
            background: var(--card-bg); padding: 20px; border-radius: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; 
            transition: background-color 0.3s; display: flex; flex-direction: column;
        }
        
        label { display: block; font-size: 13px; font-weight: 600; color: var(--txt-muted); margin-bottom: 4px; text-transform: uppercase; }
        
        input, textarea, button { 
            width: 100%; border-radius: 10px; border: 1px solid var(--border); 
            background: var(--input-bg); color: var(--txt); padding: 12px; 
            box-sizing: border-box; font-size: 16px; margin-bottom: 12px; outline: none;
            transition: border-color 0.2s, background-color 0.3s, color 0.3s;
        }
        
        input:focus, textarea:focus { border-color: var(--p); }
        
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; height: 50px; }
        button:active { transform: scale(0.98); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        textarea { height: 350px; font-family: "SF Mono", monospace; resize: none; margin-top: 4px; line-height: 1.5; flex-grow: 1; }
        
        .status { padding: 10px; border-radius: 8px; text-align: center; display: none; font-size: 14px; margin-top: 8px; font-weight: 500; }

        .progress-wrapper { width: 100%; height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--p); width: 0%; transition: width 0.1s ease-out; }

        /* [31] Tagi CSS */
        .tags-container { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; min-height: 24px; }
        .tag-pill { background: var(--p-light); color: var(--p); font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; }

        /* [32] Spis TreÅ›ci CSS */
        details.toc { margin-bottom: 12px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-size: 14px; }
        details.toc summary { font-weight: 600; cursor: pointer; outline: none; color: var(--txt-muted); list-style: none; display: flex; align-items: center; justify-content: space-between; }
        details.toc summary::-webkit-details-marker { display: none; }
        details.toc summary::after { content: "â–¼"; font-size: 10px; transition: transform 0.2s; }
        details.toc[open] summary::after { transform: rotate(180deg); }
        .toc-list { margin-top: 10px; max-height: 150px; overflow-y: auto; border-top: 1px solid var(--border); padding-top: 10px; }
        .toc-item { cursor: pointer; color: var(--p); margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toc-item:hover { text-decoration: underline; }

        /* Tryb Zen */
        body.zen-active { padding: 0; }
        body.zen-active .controls-panel { display: none; }
        body.zen-active .app { max-width: 800px; height: 100vh; display: flex; flex-direction: column; }
        body.zen-active .card.editor-card { flex-grow: 1; margin: 0; border-radius: 0; box-shadow: none; display: flex; flex-direction: column; padding: 15px; }
        body.zen-active textarea { border: none; font-size: 18px; padding: 10px; margin-bottom: 0; }
        body.zen-active .save-btn { display: none; }
        
        .zen-btn { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 28px; background: var(--p); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; border: none; transition: opacity 0.3s; }
        body.zen-active .zen-btn { opacity: 0.4; }
        body.zen-active .zen-btn:hover { opacity: 1; }
    </style>
</head>
<body>

<div class="app">
    <div class="card controls-panel">
        <label>Klucz SzyfrujÄ…cy</label>
        <input type="password" id="pass" placeholder="Silne hasÅ‚o...">
        
        <label>Nazwa pliku</label>
        <input type="text" id="fileName" placeholder="np. dziennik_wiosna">
        
        <label>Wczytaj plik (.enc)</label>
        <input type="file" id="file" accept=".enc">
        
        <div class="grid">
            <button style="background: var(--txt-muted);" onclick="decrypt()">ðŸ”“ OtwÃ³rz</button>
            <button style="background: var(--txt-muted);" onclick="addDate()">ðŸ“… Wstaw DatÄ™</button>
        </div>
    </div>

    <div class="card editor-card">
        <div class="progress-wrapper"><div id="progressBar" class="progress-bar"></div></div>
        
        <details class="toc" id="tocContainer" style="display: none;">
            <summary>Spis TreÅ›ci</summary>
            <div class="toc-list" id="tocList"></div>
        </details>

        <div class="tags-container" id="tagsContainer"></div>
        
        <textarea id="content" placeholder="Zacznij pisaÄ‡... UÅ¼yj #tagÃ³w lub nagÅ‚Ã³wkÃ³w (# NagÅ‚Ã³wek) aby zorganizowaÄ‡ tekst."></textarea>
        
        <button class="save-btn" onclick="encrypt()">ðŸ”’ Zaszyfruj i Pobierz (.enc)</button>
        <div id="msg" class="status"></div>
    </div>
</div>

<button class="zen-btn" id="zenToggleBtn" onclick="toggleZen()" title="Tryb Skupienia">ðŸ§˜</button>

<script>
    const ITER = 100000;
    const contentArea = document.getElementById('content');
    const progressBar = document.getElementById('progressBar');
    const tagsContainer = document.getElementById('tagsContainer');
    const tocContainer = document.getElementById('tocContainer');
    const tocList = document.getElementById('tocList');

    // Analizator tekstu w czasie rzeczywistym
    function analyzeText() {
        const text = contentArea.value;

        // 1. Aktualizacja paska postÄ™pu
        const scrollHeight = contentArea.scrollHeight - contentArea.clientHeight;
        progressBar.style.width = scrollHeight > 0 ? (contentArea.scrollTop / scrollHeight) * 100 + '%' : '0%';

        // 2. [31] Wykrywanie HashtagÃ³w (z polskimi znakami)
        const tagRegex = /(?:^|\s)#([a-zA-Z0-9_Ä…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼Ä„Ä†Ä˜ÅÅƒÃ“ÅšÅ¹Å»]+)/g;
        const tags = new Set();
        let match;
        while ((match = tagRegex.exec(text)) !== null) {
            tags.add(match[1].toLowerCase()); // Normalizacja do maÅ‚ych liter
        }
        
        tagsContainer.innerHTML = '';
        tags.forEach(tag => {
            const span = document.createElement('span');
            span.className = 'tag-pill';
            span.innerText = '#' + tag;
            tagsContainer.appendChild(span);
        });

        // 3. [32] Generowanie Spisu TreÅ›ci (Markdown Headers)
        const headerRegex = /^(#{1,6})\s+(.+)$/gm;
        const headers = [];
        while ((match = headerRegex.exec(text)) !== null) {
            headers.push({
                level: match[1].length,
                text: match[2],
                index: match.index
            });
        }

        if (headers.length > 0) {
            tocContainer.style.display = 'block';
            tocList.innerHTML = '';
            headers.forEach(h => {
                const div = document.createElement('div');
                div.className = 'toc-item';
                // WciÄ™cie na podstawie poziomu nagÅ‚Ã³wka
                div.style.paddingLeft = ((h.level - 1) * 15) + 'px';
                div.innerText = h.text;
                // Skrypt przewijajÄ…cy do odpowiedniego miejsca po klikniÄ™ciu
                div.onclick = () => {
                    contentArea.focus();
                    contentArea.setSelectionRange(h.index, h.index);
                    // Minimalne opÃ³Åºnienie dla przeglÄ…darek mobilnych, by poprawnie przescrollowaÄ‡
                    setTimeout(() => {
                        contentArea.blur(); 
                        contentArea.focus(); 
                    }, 10);
                };
                tocList.appendChild(div);
            });
        } else {
            tocContainer.style.display = 'none';
        }
    }

    // NasÅ‚uchiwanie zdarzeÅ„ wprowadzania tekstu i scrollowania
    contentArea.addEventListener('input', analyzeText);
    contentArea.addEventListener('scroll', () => {
        const scrollHeight = contentArea.scrollHeight - contentArea.clientHeight;
        progressBar.style.width = scrollHeight > 0 ? (contentArea.scrollTop / scrollHeight) * 100 + '%' : '0%';
    });

    // Tryb Skupienia
    function toggleZen() {
        document.body.classList.toggle('zen-active');
        document.getElementById('zenToggleBtn').innerText = document.body.classList.contains('zen-active') ? 'ðŸ“–' : 'ðŸ§˜';
        if(document.body.classList.contains('zen-active')) contentArea.focus();
    }

    function log(m, success) {
        const e = document.getElementById('msg');
        e.innerText = m; e.style.display = 'block';
        e.style.background = success ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
        e.style.color = success ? '#10b981' : '#ef4444';
        setTimeout(() => { e.style.display = 'none'; }, 4000);
    }

    function addDate() {
        contentArea.value = `\n## Wpis: ${new Date().toLocaleString('pl-PL')}\n` + contentArea.value;
        contentArea.focus(); contentArea.setSelectionRange(0, 0);
        analyzeText();
    }

    // --- Kryptografia ---
    async function getKey(pw, salt) {
        const enc = new TextEncoder();
        const bKey = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
        return crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt, iterations: ITER, hash: 'SHA-256' },
            bKey, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
        );
    }

    async function encrypt() {
        try {
            const pw = document.getElementById('pass').value;
            const text = contentArea.value;
            let name = document.getElementById('fileName').value || `dziennik_${new Date().toISOString().slice(0,10)}`;
            
            if(!pw || !text) return alert("Podaj klucz i treÅ›Ä‡!");

            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const key = await getKey(pw, salt);
            const cipher = await crypto.subtle.encrypt({name: 'AES-GCM', iv}, key, new TextEncoder().encode(text));

            const combined = new Uint8Array(16 + 12 + cipher.byteLength);
            combined.set(salt, 0); combined.set(iv, 16); combined.set(new Uint8Array(cipher), 28);

            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([combined], {type: 'application/octet-stream'}));
            a.download = name + '.enc'; a.click();
            log("Zaszyfrowano!", true);
        } catch(e) { log("BÅ‚Ä…d zapisu.", false); }
    }

    async function decrypt() {
        try {
            const pw = document.getElementById('pass').value;
            const file = document.getElementById('file').files[0];
            if(!pw || !file) return alert("Brak klucza lub pliku");

            const buf = new Uint8Array(await file.arrayBuffer());
            const key = await getKey(pw, buf.slice(0, 16));
            const dec = await crypto.subtle.decrypt({name: 'AES-GCM', iv: buf.slice(16, 28)}, key, buf.slice(28));

            contentArea.value = new TextDecoder().decode(dec);
            analyzeText(); // OdÅ›wieÅ¼a tagi i spis treÅ›ci po zaÅ‚adowaniu tekstu
            log("Odszyfrowano!", true);
        } catch(e) { log("BÅ‚Ä™dny klucz lub plik!", false); }
    }
</script>
</body>
</html>
