<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pamiƒôtnik Binarny</title>
    <style>
        :root { --p: #6366f1; --bg: #f8fafc; --txt: #1e293b; }
        body { font-family: sans-serif; background: var(--bg); color: var(--txt); padding: 15px; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 500px; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 12px; }
        input, textarea, button { width: 100%; border-radius: 10px; border: 1px solid #ddd; padding: 12px; box-sizing: border-box; font-size: 16px; margin-bottom: 8px; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; height: 50px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        textarea { height: 300px; font-family: monospace; resize: none; margin-top: 8px; }
        .status { padding: 10px; border-radius: 8px; text-align: center; display: none; font-size: 14px; margin-top: 8px; }
    </style>
</head>
<body>

<div class="app">
    <div class="card">
        <label>Klucz i Nazwa:</label>
        <input type="password" id="pass" placeholder="Has≈Ço (klucz)...">
        <input type="text" id="fileName" placeholder="Nazwa pliku (opcjonalnie)">
        
        <label>Wczytaj plik (.enc):</label>
        <input type="file" id="file" accept=".enc">
        
        <div class="grid">
            <button style="background:#64748b" onclick="decrypt()">üîì Otw√≥rz</button>
            <button style="background:#64748b" onclick="addDate()">üìÖ +Data</button>
        </div>
    </div>

    <div class="card">
        <textarea id="content" placeholder="Tre≈õƒá pamiƒôtnika..."></textarea>
        <button onclick="encrypt()">üîí Szyfruj i Pobierz (.enc)</button>
        <div id="msg" class="status"></div>
    </div>
</div>

<script>
    const ITER = 100000;

    function log(m, success) {
        const e = document.getElementById('msg');
        e.innerText = m; e.style.display = 'block';
        e.style.background = success ? '#d1fae5' : '#fee2e2';
        e.style.color = success ? '#065f46' : '#991b1b';
    }

    function addDate() {
        const area = document.getElementById('content');
        const d = new Date().toLocaleString('pl-PL');
        area.value = `--- ${d} ---\n` + area.value;
    }

    async function getKey(pw, salt) {
        const enc = new TextEncoder();
        const bKey = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
        return crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt, iterations: ITER, hash: 'SHA-256' },
            bKey, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
        );
    }

    async function encrypt() {
        try {
            const pw = document.getElementById('pass').value;
            const text = document.getElementById('content').value;
            let name = document.getElementById('fileName').value || `wpis_${new Date().toISOString().slice(0,10)}`;
            if(!pw || !text) return alert("Brak danych!");

            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const key = await getKey(pw, salt);
            const cipher = await crypto.subtle.encrypt({name: 'AES-GCM', iv}, key, new TextEncoder().encode(text));

            // ≈ÅƒÖczymy wszystko w jeden ciƒÖg bajt√≥w (Binary Packing)
            const combined = new Uint8Array(salt.length + iv.length + cipher.byteLength);
            combined.set(salt, 0);
            combined.set(iv, salt.length);
            combined.set(new Uint8Array(cipher), salt.length + iv.length);

            const blob = new Blob([combined], {type: 'application/octet-stream'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name + '.enc';
            a.click();
            log("Zapisano jako " + name + ".enc", true);
        } catch(e) { log("B≈ÇƒÖd zapisu", false); }
    }

    async function decrypt() {
        try {
            const pw = document.getElementById('pass').value;
            const file = document.getElementById('file').files[0];
            if(!pw || !file) return alert("Podaj has≈Ço i plik");

            const buf = await file.arrayBuffer();
            const fullData = new Uint8Array(buf);

            // WyciƒÖgamy bajty z konkretnych pozycji
            const salt = fullData.slice(0, 16);
            const iv = fullData.slice(16, 28);
            const data = fullData.slice(28);

            const key = await getKey(pw, salt);
            const dec = await crypto.subtle.decrypt({name: 'AES-GCM', iv}, key, data);

            document.getElementById('content').value = new TextDecoder().decode(dec);
            log("Odszyfrowano!", true);
        } catch(e) { log("B≈Çƒôdne has≈Ço lub plik!", false); }
    }
</script>
</body>
</html>
