<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PamiÄ™tnik 2.0</title>
    <style>
        :root { --p: #6366f1; --bg: #f8fafc; --txt: #1e293b; }
        body { font-family: sans-serif; background: var(--bg); color: var(--txt); padding: 20px; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 500px; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        input, textarea, button { width: 100%; border-radius: 10px; border: 1px solid #ddd; padding: 12px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        button { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.sec { background: #f1f5f9; color: var(--txt); }
        textarea { height: 250px; font-family: monospace; resize: none; }
        .status { padding: 10px; border-radius: 8px; text-align: center; display: none; font-size: 14px; }
    </style>
</head>
<body>

<div class="app">
    <div class="card">
        <label>HasÅ‚o:</label>
        <input type="password" id="pass" placeholder="Twoje tajne hasÅ‚o">
        <label>Plik:</label>
        <input type="file" id="file" accept=".json">
        <div style="display: flex; gap: 10px;">
            <button class="sec" onclick="decrypt()">ðŸ”“ OtwÃ³rz</button>
            <button class="sec" onclick="addDate()">ðŸ“… Data</button>
        </div>
    </div>

    <div class="card">
        <textarea id="content" placeholder="Tu wpisz tekst..."></textarea>
        <button onclick="encrypt()">ðŸ”’ Zaszyfruj i pobierz</button>
        <div id="msg" class="status"></div>
    </div>
</div>

<script>
    const ITER = 100000;

    function log(m, success) {
        const e = document.getElementById('msg');
        e.innerText = m;
        e.style.display = 'block';
        e.style.background = success ? '#d1fae5' : '#fee2e2';
        e.style.color = success ? '#065f46' : '#991b1b';
    }

    function addDate() {
        const area = document.getElementById('content');
        const d = new Date().toLocaleString('pl-PL');
        area.value = `\n--- ${d} ---\n` + area.value;
    }

    async function getKey(pw, salt) {
        const enc = new TextEncoder();
        const bKey = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
        return crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt, iterations: ITER, hash: 'SHA-256' },
            bKey, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
        );
    }

    async function encrypt() {
        try {
            const pw = document.getElementById('pass').value;
            const text = document.getElementById('content').value;
            if(!pw || !text) return alert("Brak hasÅ‚a lub treÅ›ci");

            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const key = await getKey(pw, salt);
            const cipher = await crypto.subtle.encrypt({name: 'AES-GCM', iv}, key, new TextEncoder().encode(text));

            const out = {
                s: btoa(String.fromCharCode(...salt)),
                i: btoa(String.fromCharCode(...iv)),
                d: btoa(String.fromCharCode(...new Uint8Array(cipher)))
            };

            const blob = new Blob([JSON.stringify(out)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'pamietnik.json';
            a.click();
            log("Zapisano!", true);
        } catch(e) { log("BÅ‚Ä…d szyfrowania", false); }
    }

    async function decrypt() {
        try {
            const pw = document.getElementById('pass').value;
            const file = document.getElementById('file').files[0];
            if(!pw || !file) return alert("Podaj hasÅ‚o i plik");

            const raw = JSON.parse(await file.text());
            const salt = new Uint8Array(atob(raw.s).split('').map(c => c.charCodeAt(0)));
            const iv = new Uint8Array(atob(raw.i).split('').map(c => c.charCodeAt(0)));
            const data = new Uint8Array(atob(raw.d).split('').map(c => c.charCodeAt(0)));

            const key = await getKey(pw, salt);
            const dec = await crypto.subtle.decrypt({name: 'AES-GCM', iv}, key, data);

            document.getElementById('content').value = new TextDecoder().decode(dec);
            log("Odszyfrowano!", true);
        } catch(e) { log("BÅ‚Ä™dne hasÅ‚o!", false); }
    }
</script>
</body>
</html>
